# AI 编码准则

本文档定义 AI 辅助编码时必须遵守的规则。

> **本文档是活文档**：当用户在对话中提出新的编码要求或偏好时，必须实时更新此文件。

## 代码风格

- 注释是文档，**不可精简、不可删除**
- 逻辑流程可以精简，但**不能丢失可用性**
- 用 `══` 分割线隔离代码块，注释保持对齐
- 中文注释优先，变量名和日志用中文描述
- **不自创缩写**，变量名必须语义清晰（如 `lock_id` 而非 `lk`）
- **禁止歧义命名**：名称只能有唯一解读，不允许多义缩写
  - ❌ `min` (最小值？分钟？) → ✅ `minute` 或 `minimum`
  - ❌ `IV` (四？interval？) → ✅ `INTERVAL`
  - ❌ `last_m` (最后的M？) → ✅ `last_minute`
  - ❌ `n` (数量？名称？) → ✅ `count` 或 `name`
- 单文件架构优先，不拆分除非必要

## 函数设计

- 可测试性优先：核心逻辑提取为**纯函数** (无 I/O)
- 纯函数与 I/O 函数分离，便于单元测试和快进模拟
- 使用回调模式解耦决策与执行 (如 `on_fire` 回调)
- 模块级代码用 `if __name__ == "__main__":` 保护

## 日志规范

- **隐藏敏感信息**：日志中不暴露仓库名、工作流名
- **显示任务摘要**：数量 + 时间表达式
- **启动日志多行**：用分隔线包裹，包含 run id
- **续期/完成日志**：全链路有输出，便于排查
- 使用 emoji 区分状态：🎯 获锁 / ⏭️ 跳过 / ✅❌ 结果 / 🛡️ 守护 / 🛑 退出 / 🔄 续期

## 测试规范

- 零依赖：仅使用 `assert` + 标准库，不引入 pytest
- 测试前设置模拟环境变量，导入纯函数
- 快进模拟：用假时钟替代 `time.sleep`，瞬间验证长周期逻辑
- 端到端：从 DISPATCH 文本 → 解析 → 调度模拟，覆盖全链路
- 回归测试：每个已修复的 bug 必须有对应防护用例

## README 规范

- **三语同步**：简体中文、繁体中文、英文，内容一致
- **架构图纯 ASCII 对齐**：避免中文字符导致宽度不一致
- **数据与代码一致**：文档中的频率、轮次等描述必须与代码匹配
- **核心函数表**：列出所有公开函数及职责

## 变更流程

- 每次修改后**全面自检**
- 审查变更是否影响逻辑，**逐项列表确认**
- 重大变更实施前**与用户沟通**
- 修改完成后**运行 test_tick.py 验证**
- commit message 用中文，格式：`类型: 简要描述`

## 设计原则

- 极简：零外部依赖，单文件优先
- 容错：所有 API 调用考虑失败情况
- 安全：敏感信息不进日志
- 稳定：功能变更必须等价验证
- 可测：核心逻辑必须可独立测试
