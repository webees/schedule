name: tick-c

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  actions: write

jobs:
  tick:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    env:
      GH_TOKEN: ${{ github.token }}
      REPO: ${{ github.repository }}
    steps:
      - name: ðŸ”„ å®šæ—¶å¾ªçŽ¯
        run: |
          SELF="${{ github.workflow }}"
          LETTER=${SELF: -1}
          case $LETTER in
            a) OFFSET=0 ;;
            b) OFFSET=1 ;;
            c) OFFSET=2 ;;
          esac
          echo "ðŸš€ $SELF å¯åŠ¨ (offset=$OFFSET)"

          for i in $(seq 1 300); do
            # å¯¹é½åˆ°æ•´åˆ†é’Ÿ
            SEC=$(date -u '+%-S')
            WAIT=$((60 - SEC))
            [ "$WAIT" -gt 0 ] && [ "$WAIT" -le 60 ] && sleep $WAIT

            # åªåœ¨å±žäºŽè‡ªå·±çš„åˆ†é’Ÿè§¦å‘
            MIN=$(date -u '+%-M')
            if [ $((MIN % 3)) -eq $OFFSET ]; then
              # exec æœªè¿è¡Œæ—¶æ‰è§¦å‘
              S=$(gh run list -w exec.yml --json status -q '.[0].status' -R $REPO --limit 1 2>/dev/null)
              if [ "$S" != "in_progress" ] && [ "$S" != "queued" ]; then
                echo "ðŸŽ¯ [$i] $(date -u '+%H:%M:%S') è§¦å‘ exec"
                gh workflow run exec.yml -R $REPO 2>/dev/null || true
              else
                echo "â­ï¸ [$i] $(date -u '+%H:%M:%S') exec è¿è¡Œä¸­, è·³è¿‡"
              fi
            fi
          done

      - name: ðŸ”„ ç»­æœŸ
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          SELF="${{ github.workflow }}.yml"
          QUEUED=$(gh run list -w $SELF -s queued --json databaseId -q 'length' -R $REPO)
          [ "$QUEUED" -eq 0 ] && gh workflow run $SELF -R $REPO
          echo "âœ… å·²è§¦å‘ä¸‹ä¸€å‘¨æœŸ"

      - name: ðŸ‘€ å®ˆæŠ¤
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          SELF="${{ github.workflow }}"
          for t in tick-a tick-b tick-c; do
            [ "$t" = "$SELF" ] && continue
            S=$(gh run list -w $t.yml --json status -q '.[0].status' -R $REPO --limit 1)
            if [ "$S" != "in_progress" ] && [ "$S" != "queued" ]; then
              echo "âš ï¸ $t å·²åœæ­¢, è§¦å‘ guard"
              gh workflow run guard.yml -R $REPO 2>/dev/null || true
              break
            fi
          done
