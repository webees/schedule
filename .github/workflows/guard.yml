name: guard

on: workflow_dispatch

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions:
  actions: write

jobs:
  guard:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      REPO: ${{ github.repository }}
    steps:
      - id: check
        run: |
          alive=$(
            gh run list -R "$REPO" --limit 10 \
              --json workflowName,status \
              -q 'map(select(.status == "in_progress" or .status == "queued"))
                  | map(.workflowName)
                  | unique
                  | join(",")'
          )
          echo "alive=${alive}" >> "$GITHUB_OUTPUT"
      - if: ${{ !contains(steps.check.outputs.alive, 'tick-a') }}
        run: gh workflow run tick-a.yml -R "$REPO"
      - if: ${{ !contains(steps.check.outputs.alive, 'tick-b') }}
        run: gh workflow run tick-b.yml -R "$REPO"
