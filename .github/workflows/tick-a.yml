name: tick-a

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

permissions:
  actions: write

jobs:
  tick:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      REPO: ${{ github.repository }}
    steps:
      - name: â±ï¸ heartbeat
        run: echo "${{ github.workflow }} | $(date -u '+%Y-%m-%d %H:%M:%S') UTC | run#${{ github.run_number }}"

      - name: ðŸ’¤ sleep
        run: sleep 160

      - name: ðŸ”„ è‡ªè°ƒåº¦
        if: always()
        run: |
          SELF="${{ github.workflow }}.yml"
          QUEUED=$(gh run list -w $SELF -s queued --json databaseId -q 'length' -R $REPO)
          [ "$QUEUED" -eq 0 ] && gh workflow run $SELF -R $REPO

      - name: ðŸ‘€ å®ˆæŠ¤
        if: always()
        run: |
          SELF="${{ github.workflow }}"
          for t in tick-a tick-b tick-c; do
            [ "$t" = "$SELF" ] && continue
            S=$(gh run list -w $t.yml --json status -q '.[0].status' -R $REPO --limit 1)
            if [ "$S" != "in_progress" ] && [ "$S" != "queued" ]; then
              echo "âš ï¸ $t å·²åœæ­¢, è§¦å‘ guard"
              gh workflow run guard.yml -R $REPO 2>/dev/null || true
              break
            fi
          done
