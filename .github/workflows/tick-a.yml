name: tick-a

on:
  workflow_dispatch:

concurrency:
  group: tick-a
  cancel-in-progress: false

permissions:
  actions: write

jobs:
  tick:
    runs-on: ubuntu-latest
    steps:
      - name: â±ï¸ tick-a
        run: echo "tick-a | $(date -u '+%Y-%m-%d %H:%M:%S') UTC | run#${{ github.run_number }}"

      - name: ðŸ’¤ sleep 180s
        run: sleep 180

      - name: ðŸ”„ è‡ªè°ƒåº¦
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          QUEUED=$(gh run list -w tick-a.yml -s queued --json databaseId -q 'length' -R $REPO)
          [ "$QUEUED" -eq 0 ] && gh workflow run tick-a.yml -R $REPO

      - name: ðŸ‘€ å®ˆæŠ¤æ£€æµ‹
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          for w in tick-b.yml tick-c.yml; do
            S=$(gh run list -w $w --json status -q '.[0].status' -R $REPO --limit 1)
            if [ "$S" != "in_progress" ] && [ "$S" != "queued" ]; then
              echo "âš ï¸ $w å·²åœæ­¢, è§¦å‘ revive"
              gh workflow run guard.yml -R $REPO 2>/dev/null || true
              break
            fi
          done
